// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test, console} from "forge-std/Test.sol";

contract LibZipTest is Test {
    address public oldLibZip;
    address public newLibZip;
    // The calldata from random AA transaction; Check https://basescan.org/tx/0xf599d38bd5e2d859c6c2a10e5a1eafdf7a08892ec496cd6aa7b072b3ad0b0cb4
    bytes constant private _byte_1 = "0x34fcd5be000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000777777751622c0d3258f214f9df38e35bf45baf30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000006440d36fc77000000000000000000000000cb22e75ed88523eac7e952acd17196d5cb067483000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000d9d3bb1dc7512db7a63ac715cf20923ab748b96a000000000000000000000000cb22e75ed88523eac7e952acd17196d5cb0674830000000000000000000000007c51689723c3b7905c8f3095590468a7f053ab220000000000000000000000000000000000000000000000000000000000000042697066733a2f2f626166796265696575337271673375706e686c35376a3373626d663635376d75656f6e7369797162737432716c627268663568637672657275686100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000175a6f726120456e676c697368204a6f6b657320426c6f6200000000000000000000000000000000000000000000000000000000000000000000000000000000145a6f7261456e676c6973684a6f6b6573426c6f6200000000000000000000000000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000004000000000000000000000000c04cacc4cf241d25cc8a2a0c9c08bb23bd62eb2900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000004fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffea3f4ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1d0cffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff53bcffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7acc0000000000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd4a40000000000000000000000000000000000000000000000000000000000000b540000000000000000000000000000000000000000000000000000000000000b540000000000000000000000000000000000000000000000000000000000000b540000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000214e8348c4f000000000000000000000000000000000000000000000000000003782dace9d9000000000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000000000010a741a462780000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    // The data from example of vectorized - packing 3 uint256 variables. Check https://x.com/optimizoor/status/1914238227386704053
    bytes constant private _byte_2 = "0x000000000000000000000000000000000000000000000000000000000011223300000000000000000000000000000000000000000000000001020304050607080000000000000000000000000000000000000000000000000000000000f1f2f3";

    function setUp() public {
        // Deploy 2 YulLibZip runtime with wrapper
        bytes memory oldRuntime = hex"36156102bc5760045f80376383a095055f5160e01c1461001d575f80fd5b602060045f3760405f5160208160040181376020805191600401016080915f83528060208401948594019283375f81830152810160018392035b60018203810361009d5750506004820151196004830152039060206080528160a05260c05f5b83811061008c57836040016080f35b80602091840151818401520161007d565b600191929350019182515f1a90811561020a5760ff82146101885760019181530160018301518082527f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f9080198280831916011790828082160117161719806f8421084210842108cc6318c6db6d54be1060071b81811c60018060401b031060061b177fc0c8c8d0c8e8d0d8c8e8e0e8d0d8e0f0c8d0e8d0e0e0d8f0d0d0e0d8f8f8f8f86f8421084210842108cc6318c6db6d54be83831c66020408102040810260181a1c601f161a1860031c90150183830381188484038211021880910192015b90839291610057565b60029150608060208086015119806101c2575b508585038082189082110218601f8118601f82110218809501941760f01b8152019161017f565b809150600180841b031060071b81811c60018060401b031060061b1781811c63ffffffff1060051b1781811c61ffff1060041b1790811c60ff109060031c17601f185f61019b565b9190505f939293915b6001850151948515610284576002929394958060018060801b031060071b81811c60018060401b031060061b1781811c63ffffffff1060051b1781811c61ffff1060041b1790811c60ff109060031c17601f1881850381188286038211021880910194015b60f01b8152019161017f565b929450601f8383036020811860208211021886607f038118607f82890111021880809501960193116102135760029192949394610278565b5f80f3";
        bytes memory newRuntime = hex"36610008575f5ff35b60045f5f375f5160e01c6383a0950581036102fe57602060045f375f516020816004016020376020516020826004010160805f81526020810160408201601f19601f19601f87010116858583375f868301528582017f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f84600185035b6001840381146102bd5760018101905080515f1a80610131575f5b60011561011e576001830151806100f1578387036020811860208211028118905082607f038118607f82850111028118905080850194508083019250601f81116100ea57505061011e565b5050610119565b5f6008821e04905084880381188589038211028118905080850194508083019250505061011e565b61009f565b8060f01b845260028401935050506102b8565b60ff81036101d8576020808301511980156101a057806fffffffffffffffffffffffffffffffff1060071b81811c67ffffffffffffffff1060061b8117905081811c63ffffffff1060051b8117905081811c61ffff1060041b8117905081811c60ff108160031c17601f189250505b8387038083188184110283189250601f8318601f841102831892505081840193506080821760f01b85526002850194505050506102b8565b80835360018301925060018201518084527f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f80821982838519160117838384861601171617199150816f8421084210842108cc6318c6db6d54be1060071b8083821c67ffffffffffffffff1060061b179050807fc0c8c8d0c8e8d0d8c8e8e0e8d0d8e0f0c8d0e8d0e0e0d8f0d0d0e0d8f8f8f8f86f8421084210842108cc6318c6db6d54be85841c66020408102040810260181a1c601f161a1860031c831501905084880381188589038211028118905080860195508085019450505050505b610084565b50600486015119600487015285810360206080528060a0528660c05f5b838110156102f55780830151818301526020810190506102da565b50826040016080f35b5f5ffd";
        
        oldLibZip = _deployCode(oldRuntime);
        newLibZip = _deployCode(newRuntime);
    }

    function test_compress_beforeFusaka_byte1() public view {
        bytes4 sel = bytes4(keccak256("cdCompress(bytes)"));
        (bool ok,) = oldLibZip.staticcall(abi.encodeWithSelector(sel, _byte_1));
        assertEq(ok, true);
    }

    function test_compress_afterFusaka_byte1() public view {
        bytes4 sel = bytes4(keccak256("cdCompress(bytes)"));
        (bool ok,) = newLibZip.staticcall(abi.encodeWithSelector(sel, _byte_1));
        assertEq(ok, true);
    }

    function test_compress_beforeFusaka_byte2() public view {
        bytes4 sel = bytes4(keccak256("cdCompress(bytes)"));
        (bool ok,) = oldLibZip.staticcall(abi.encodeWithSelector(sel, _byte_2));
        assertEq(ok, true);
    }

    function test_compress_afterFusaka_byte2() public view {
        bytes4 sel = bytes4(keccak256("cdCompress(bytes)"));
        (bool ok,) = newLibZip.staticcall(abi.encodeWithSelector(sel, _byte_2));
        assertEq(ok, true);
    }

    function _deployCode(bytes memory runtime) public returns (address) {
        address deployed;
        assembly {
            // Wrapper: PUSH2 0x02bc DUP1 PUSH1 0x0a RETURNDATASIZE CODECOPY RETURNDATASIZE RETURN
            // = 61 02bc 80 60 0a 3d 39 3d f3
            let ptr := mload(0x40)
            // Store wrapper prefix (10 bytes)
            mstore(ptr, shl(176, 0x6102bc80600a3d393df3))
            // Copy runtime after wrapper (offset 0x0a = 10 bytes)
            let runtimeSize := mload(runtime)
            let runtimePtr := add(runtime, 0x20)
            // Manual copy loop
            for { let i := 0 } lt(i, runtimeSize) { i := add(i, 0x20) } {
                mstore(add(add(ptr, 0x0a), i), mload(add(runtimePtr, i)))
            }
            // Deploy: CREATE with value=0, offset=ptr, size=0x0a+runtimeSize
            deployed := create(0, ptr, add(0x0a, runtimeSize))
            if iszero(deployed) {
                revert(0, 0)
            }
        }
        return deployed;
    }
}
